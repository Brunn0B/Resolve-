<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resolve+ | Finalizar Compra</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root {
            --primary: #082945;
            --primary-light: #d1d1d1;
            --secondary: #0e53029b;
            --accent: #ffffff;
            --light: #e9e9e9;
            --dark: #212529;
            --success: #414141;
            --success-light: #e8f8fd;
            --warning: #ffc107;
            --danger: #f72585;
            --gray: #6c757d;
            --gray-light: #f1f3f5;
        }
        
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .checkout-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .checkout-steps {
            display: flex;
            flex: 1;
            justify-content: space-between;
            position: relative;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--gray-light);
            color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            border: 3px solid white;
        }
        
        .step.active .step-number {
            background-color: var(--primary);
            color: white;
        }
        
        .step.completed .step-number {
            background-color: var(--success);
            color: white;
        }
        
        .step-title {
            font-size: 0.9rem;
            color: var(--gray);
            text-align: center;
        }
        
        .step.active .step-title {
            color: var(--primary);
            font-weight: 500;
        }
        
        .step.completed .step-title {
            color: var(--success);
        }
        
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: var(--gray-light);
            z-index: 1;
        }
        
        .progress {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        
        .checkout-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 992px) {
            .checkout-content {
                grid-template-columns: 1fr 350px;
            }
        }
        
        .main-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        .payment-methods {
            margin-bottom: 20px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .payment-option:hover {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }
        
        .payment-option.selected {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }
        
        .payment-radio {
            margin-right: 15px;
        }
        
        .payment-info {
            flex: 1;
        }
        
        .payment-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .payment-description {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .payment-icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-left: 15px;
        }
        
        .card-form {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--gray-light);
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        
        .card-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        @media (min-width: 576px) {
            .card-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .card-images {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .card-image {
            height: 24px;
            opacity: 0.5;
        }
        
        .card-image.active {
            opacity: 1;
        }
        
        .confirmation-message {
            text-align: center;
            padding: 20px 0;
        }
        
        .confirmation-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 15px;
        }
        
        .confirmation-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .confirmation-text {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .order-details {
            background-color: var(--gray-light);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .detail-label {
            color: var(--gray);
        }
        
        .detail-value {
            font-weight: 500;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (min-width: 576px) {
            .action-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-align: center;
            justify-content: center;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        
        .btn-outline {
            background: none;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-light);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3aa8d8;
        }
        
        .sidebar-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 20px;
        }
        
        .order-summary {
            margin-bottom: 20px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .secure-payment {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .boleto-preview, .pix-preview {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }
        
        .boleto-code-container, .pix-key-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        #boleto-code, #pix-key {
            font-family: monospace;
            font-size: 1rem;
            padding: 8px;
            background-color: var(--gray-light);
            border-radius: 4px;
            flex: 1;
            word-break: break-all;
        }
        
        .boleto-actions, .pix-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (min-width: 576px) {
            .boleto-actions, .pix-actions {
                flex-direction: row;
            }
        }
        
        .boleto-qrcode, .pix-qrcode {
            margin: 15px auto;
            text-align: center;
        }
        
        .installments-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
        
        .saved-cards {
            margin-top: 15px;
        }
        
        .saved-card {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .saved-card:hover {
            border-color: var(--primary);
        }
        
        .saved-card.selected {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }
        
        .card-brand {
            margin-left: 10px;
            font-weight: 500;
        }
        
        .card-number {
            margin-left: auto;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .no-cards-message {
            padding: 15px;
            background-color: var(--gray-light);
            border-radius: 6px;
            text-align: center;
            color: var(--gray);
        }
        
        .add-card-btn {
            margin-top: 10px;
            width: 100%;
        }

        .barcode-container {
            margin: 10px 0;
            text-align: center;
        }
        
        .barcode {
            height: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="checkout-header">
            <div class="checkout-steps">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <div class="step-title">Carrinho</div>
                </div>
                <div class="step completed">
                    <div class="step-number">2</div>
                    <div class="step-title">Dados</div>
                </div>
                <div class="step active" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-title">Pagamento</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-title">Confirmação</div>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="checkout-progress"></div>
                </div>
            </div>
        </div>
        
        <div class="checkout-content">
            <div class="main-section" id="payment-section">
                <h2 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Método de Pagamento
                </h2>
                
                <div class="payment-methods">
                    <div class="payment-option" data-method="card">
                        <div class="payment-radio">
                            <i class="far fa-circle"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-title">Cartão de Crédito</div>
                            <div class="payment-description">Parcelamento em até 12x</div>
                        </div>
                        <div class="payment-icon">
                            <i class="far fa-credit-card"></i>
                        </div>
                    </div>
                    
                    <div class="card-form" id="card-form">
                        <div class="saved-cards" id="saved-cards">
                            <!-- Cartões salvos serão inseridos aqui -->
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Número do Cartão</label>
                            <input type="text" class="form-input" id="card-number" placeholder="0000 0000 0000 0000" maxlength="19">
                            <div class="card-images">
                                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/visa/visa-original.svg" class="card-image" id="visa">
                                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/mastercard/mastercard-original.svg" class="card-image" id="mastercard">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fa/American_Express_logo_%282018%29.svg/1200px-American_Express_logo_%282018%29.svg.png" class="card-image" style="height: 20px;" id="amex">
                                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/apple/apple-original.svg" class="card-image" id="elo">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Nome no Cartão</label>
                            <input type="text" class="form-input" id="card-name" placeholder="Como escrito no cartão">
                        </div>
                        
                        <div class="card-row">
                            <div class="form-group">
                                <label class="form-label">Validade</label>
                                <input type="text" class="form-input" id="card-expiry" placeholder="MM/AA" maxlength="5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-input" id="card-cvv" placeholder="000" maxlength="4">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Parcelamento</label>
                            <select class="installments-select" id="installments">
                                <!-- Opções de parcelamento serão inseridas aqui -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="save-card"> Salvar este cartão para compras futuras
                            </label>
                        </div>
                    </div>
                    
                    <div class="payment-option selected" data-method="boleto">
                        <div class="payment-radio">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-title">Boleto Bancário</div>
                            <div class="payment-description">Pagamento em até 3 dias úteis</div>
                        </div>
                        <div class="payment-icon">
                            <i class="fas fa-barcode"></i>
                        </div>
                    </div>
                    
                    <div class="boleto-preview" id="boleto-preview">
                        <h3>Boleto Bancário</h3>
                        <p>Vencimento: <span id="boleto-due-date"></span></p>
                        <div class="boleto-code-container">
                            <p id="boleto-code"></p>
                            <button class="btn btn-outline" id="copy-boleto-btn">
                                <i class="fas fa-copy"></i> Copiar
                            </button>
                        </div>
                        <div class="barcode-container">
                            <svg id="boleto-barcode" class="barcode"></svg>
                        </div>
                        <p>Ou pague diretamente pelo link:</p>
                        <div class="boleto-actions">
                            <a href="#" id="boleto-link" class="btn btn-primary" target="_blank">
                                <i class="fas fa-external-link-alt"></i> Pagar Boleto
                            </a>
                            <button class="btn btn-outline" id="download-boleto-btn">
                                <i class="fas fa-file-pdf"></i> Baixar Boleto
                            </button>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-method="pix">
                        <div class="payment-radio">
                            <i class="far fa-circle"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-title">PIX</div>
                            <div class="payment-description">Pagamento instantâneo</div>
                        </div>
                        <div class="payment-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                    </div>

                    <div class="pix-preview" id="pix-preview">
                        <h3>Pagamento via PIX</h3>
                        <p>Vencimento: <span id="pix-due-date"></span></p>
                        <div class="pix-qrcode" id="pix-qrcode"></div>
                        <p>Ou copie a chave PIX abaixo:</p>
                        <div class="pix-key-container">
                            <p id="pix-key"></p>
                            <button class="btn btn-outline" id="copy-pix-btn">
                                <i class="fas fa-copy"></i> Copiar
                            </button>
                        </div>
                        <div class="pix-actions">
                            <button class="btn btn-primary" id="screenshot-btn">
                                <i class="fas fa-camera"></i> Tirar Print
                            </button>
                        </div>
                    </div>
                </div>
                
                <button id="confirm-payment-btn" class="btn btn-primary" style="width: 100%; padding: 12px; margin-top: 15px;">
                    <i class="fas fa-check-circle"></i> Confirmar Pagamento
                </button>
            </div>
            
            <div class="main-section" id="confirmation-section" style="display: none;">
                <div class="confirmation-message">
                    <div class="confirmation-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 class="confirmation-title">Compra realizada com sucesso!</h2>
                    <p class="confirmation-text">
                        Obrigado por escolher os serviços da Resolve+. Seu pedido foi processado com sucesso 
                        e em breve você receberá um e-mail com todos os detalhes da sua contratação.
                    </p>
                    
                    <div class="order-details">
                        <div class="detail-item">
                            <span class="detail-label">Número do Pedido:</span>
                            <span class="detail-value" id="order-number"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Data:</span>
                            <span class="detail-value" id="order-date"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Método de Pagamento:</span>
                            <span class="detail-value" id="payment-method"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Valor Total:</span>
                            <span class="detail-value" id="order-total"></span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <a href="Mensalidade.html" class="btn btn-primary">
                            <i class="fas fa-home"></i> Voltar ao Início
                        </a>
                        <button class="btn btn-outline" id="download-invoice-btn">
                            <i class="fas fa-file-pdf"></i> Baixar Nota Fiscal
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h2 class="section-title" style="font-size: 1.2rem;">
                    <i class="fas fa-shopping-cart"></i>
                    Resumo do Pedido
                </h2>
                
                <div class="order-summary" id="order-summary">
                    <!-- Itens do pedido serão inseridos aqui -->
                </div>
                
                <div class="order-total">
                    <span>Total</span>
                    <span id="order-total-sidebar">R$ 0,00</span>
                </div>
                
                <div class="secure-payment">
                    <i class="fas fa-lock"></i>
                    <span>Pagamento 100% seguro</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializa o jsPDF
        const { jsPDF } = window.jspdf;
        
        // Variáveis globais
        let currentOrder = null;
        let userCards = [];
        let selectedCard = null;
        let selectedPaymentMethod = 'boleto';
        let currentUser = null;
        
        // Funções principais
        function updateProgress(percent) {
            document.getElementById('checkout-progress').style.width = percent + '%';
        }
        
        function selectPaymentMethod(element, method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('.payment-radio i').className = 'far fa-circle';
            });
            
            element.classList.add('selected');
            element.querySelector('.payment-radio i').className = 'fas fa-check-circle';
            
            document.querySelectorAll('.card-form, .boleto-preview, .pix-preview').forEach(form => {
                form.style.display = 'none';
            });
            
            if (method === 'card') {
                document.getElementById('card-form').style.display = 'block';
                checkSavedCards();
            } else if (method === 'boleto') {
                document.getElementById('boleto-preview').style.display = 'block';
                if (currentOrder && currentOrder.boleto) {
                    document.getElementById('boleto-code').textContent = currentOrder.boleto.codigo;
                    document.getElementById('boleto-due-date').textContent = formatDate(currentOrder.boleto.vencimento);
                    document.getElementById('boleto-link').href = currentOrder.boleto.url;
                    
                    // Gera o código de barras
                    JsBarcode("#boleto-barcode", currentOrder.boleto.codigo.replace(/\s/g, ''), {
                        format: "CODE128",
                        lineColor: "#000000",
                        width: 2,
                        height: 40,
                        displayValue: false
                    });
                }
            } else if (method === 'pix') {
                document.getElementById('pix-preview').style.display = 'block';
                if (currentOrder && currentOrder.pix) {
                    document.getElementById('pix-key').textContent = currentOrder.pix.key;
                    document.getElementById('pix-due-date').textContent = formatDate(currentOrder.pix.expirationDate);
                    generateQRCode(currentOrder.pix.qrCode, 'pix-qrcode');
                }
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        function generateInvoicePDF() {
            if (!currentOrder || !currentUser) return;
            
            const doc = new jsPDF();
            
            // Configurações iniciais
            doc.setFont('helvetica');
            
            // Cabeçalho
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('NOTA FISCAL', 105, 20, { align: 'center' });
            
            // Logo e informações da empresa
            doc.setFontSize(12);
            doc.text('Resolve+', 20, 30);
            doc.setFontSize(10);
            doc.text('Soluções em Serviços', 20, 35);
            doc.text('CNPJ: 12.345.678/0001-99', 20, 40);
            doc.text('Projeto Universitário FACENS', 20, 45);
            
            // Linha divisória
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.line(20, 50, 190, 50);
            
            // Informações do cliente
            doc.setFontSize(12);
            doc.text('Cliente:', 20, 60);
            doc.text(currentUser.name, 50, 60);
            
            doc.text('CPF:', 20, 65);
            doc.text(currentUser.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'), 50, 65);
            
            doc.text('Email:', 20, 70);
            doc.text(currentUser.email, 50, 70);
            
            // Informações do pedido
            doc.text('Número do Pedido:', 20, 80);
            doc.text(currentOrder._id, 50, 80);
            
            doc.text('Data:', 20, 85);
            doc.text(formatDate(currentOrder.dataPedido), 50, 85);
            
            doc.text('Método de Pagamento:', 20, 90);
            doc.text(currentOrder.metodoPagamento, 50, 90);
            
            // Itens do pedido
            doc.setFontSize(12);
            doc.text('Itens do Pedido', 105, 100, { align: 'center' });
            
            // Cabeçalho da tabela
            doc.setFontSize(10);
            doc.text('Descrição', 20, 110);
            doc.text('Frequência', 100, 110);
            doc.text('Valor', 170, 110, { align: 'right' });
            
            // Linha divisória
            doc.line(20, 115, 190, 115);
            
            let yPosition = 125;
            currentOrder.servicos.forEach((servico, index) => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(servico.servico?.nome || 'Serviço', 20, yPosition);
                doc.text(servico.frequencia === 'anual' ? 'Anual' : 'Mensal', 100, yPosition);
                doc.text(formatCurrency(servico.valor), 170, yPosition, { align: 'right' });
                
                yPosition += 10;
            });
            
            // Total
            doc.setFontSize(12);
            doc.text('Total:', 150, yPosition + 10);
            doc.text(formatCurrency(currentOrder.total), 170, yPosition + 10, { align: 'right' });
            
            // Observações
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Este boleto é um teste de compra. Não haverá nenhuma cobrança real.', 20, yPosition + 30);
            doc.text('Este teste faz parte de um projeto universitário da instituição FACENS.', 20, yPosition + 35);
            doc.text('Plataforma Resolve+ - Proprietário: Croesus', 20, yPosition + 40);
            
            // Salva o PDF
            doc.save(`nota-fiscal-resolveplus-${currentOrder._id}.pdf`);
        }
        
        function generateBoletoPDF() {
            if (!currentOrder || !currentOrder.boleto || !currentUser) return;
            
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('BOLETO BANCÁRIO', 105, 20, { align: 'center' });
            
            // Logo (simulado)
            doc.setFontSize(12);
            doc.text('Resolve+', 20, 30);
            doc.setFontSize(10);
            doc.text('Soluções em Serviços', 20, 35);
            doc.text('Projeto Universitário FACENS', 20, 40);
            
            // Linha divisória
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.line(20, 45, 190, 45);
            
            // Dados do beneficiário
            doc.setFontSize(10);
            doc.text('Beneficiário:', 20, 55);
            doc.text('Resolve+ Soluções em Serviços LTDA', 50, 55);
            
            doc.text('CNPJ:', 20, 60);
            doc.text('12.345.678/0001-99', 50, 60);
            
            // Dados do pagador
            doc.text('Pagador:', 20, 70);
            doc.text(currentUser.name, 50, 70);
            
            doc.text('CPF:', 20, 75);
            doc.text(currentUser.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'), 50, 75);
            
            // Dados do boleto
            doc.text('Vencimento:', 20, 85);
            doc.text(formatDate(currentOrder.boleto.vencimento), 50, 85);
            
            doc.text('Valor:', 20, 90);
            doc.text(formatCurrency(currentOrder.total), 50, 90);
            
            doc.text('Número do Documento:', 20, 95);
            doc.text(currentOrder._id, 50, 95);
            
            // Código de barras
            doc.setFontSize(8);
            doc.text('Código de barras:', 20, 105);
            
            // Adiciona o código de barras (simulado)
            const barcodeText = currentOrder.boleto.codigo.replace(/\s/g, '');
            doc.setFontSize(12);
            doc.text(barcodeText, 20, 110);
            
            // Linha de corte
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('-------------------------------------------------------------------', 105, 150, { align: 'center' });
            doc.text('Corte aqui', 105, 155, { align: 'center' });
            
            // Recibo do pagador
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text('Recibo do Pagador', 105, 165, { align: 'center' });
            
            doc.setFontSize(8);
            doc.text('Nome: ___________________________________________________', 20, 175);
            doc.text('CPF/CNPJ: ______________________________________________', 20, 180);
            doc.text('Endereço: ______________________________________________', 20, 185);
            doc.text('Data: ____/____/________   Assinatura: _________________', 20, 190);
            
            // Observações
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Observações:', 20, 200);
            doc.text('- Este boleto é um teste de compra. Não haverá nenhuma cobrança real.', 20, 205);
            doc.text('- Este teste faz parte de um projeto universitário da instituição FACENS.', 20, 210);
            doc.text('- Plataforma Resolve+ - Proprietário: Croesus', 20, 215);
            
            // Salva o PDF
            doc.save(`boleto-resolveplus-${currentOrder._id}.pdf`);
        }
        
        function generateQRCode(text, elementId) {
            try {
                const element = document.getElementById(elementId);
                element.innerHTML = '';
                
                new QRCode(element, {
                    text: text,
                    width: 150,
                    height: 150,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (error) {
                console.error('Erro ao gerar QR Code:', error);
                document.getElementById(elementId).innerHTML = 
                    '<p>Erro ao gerar QR Code. Por favor, copie a chave manualmente.</p>';
            }
        }
        
        async function checkSavedCards() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    renderSavedCards([]);
                    return;
                }
                
                const response = await fetch('/api/user-cards', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao buscar cartões');
                
                const cards = await response.json();
                renderSavedCards(cards);
            } catch (error) {
                console.error('Erro ao buscar cartões:', error);
                renderSavedCards([]);
            }
        }
        
        function renderSavedCards(cards) {
            const container = document.getElementById('saved-cards');
            container.innerHTML = '';
            
            if (cards.length === 0) {
                container.innerHTML = `
                    <div class="no-cards-message">
                        Nenhum cartão salvo encontrado
                    </div>
                    <button class="btn btn-outline add-card-btn" id="add-card-btn">
                        <i class="fas fa-plus"></i> Adicionar Cartão
                    </button>
                `;
                return;
            }
            
            const title = document.createElement('p');
            title.textContent = 'Cartões salvos:';
            title.style.fontWeight = '500';
            title.style.marginBottom = '10px';
            container.appendChild(title);
            
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'saved-card';
                cardElement.dataset.cardId = card._id;
                
                cardElement.innerHTML = `
                    <i class="fab fa-cc-${card.brand}"></i>
                    <span class="card-brand">${card.holderName}</span>
                    <span class="card-number">**** **** **** ${card.lastFour}</span>
                `;
                
                cardElement.addEventListener('click', () => {
                    document.querySelectorAll('.saved-card').forEach(c => c.classList.remove('selected'));
                    cardElement.classList.add('selected');
                    selectedCard = card;
                });
                
                container.appendChild(cardElement);
            });
            
            const addCardBtn = document.createElement('button');
            addCardBtn.className = 'btn btn-outline add-card-btn';
            addCardBtn.id = 'add-card-btn';
            addCardBtn.innerHTML = '<i class="fas fa-plus"></i> Adicionar outro cartão';
            container.appendChild(addCardBtn);
        }
        
        function updateInstallments(total) {
            const select = document.getElementById('installments');
            select.innerHTML = '';
            
            const maxInstallments = 12;
            const minInstallmentValue = 10;
            
            let availableInstallments = maxInstallments;
            
            while (availableInstallments > 1) {
                if (total / availableInstallments >= minInstallmentValue) {
                    break;
                }
                availableInstallments--;
            }
            
            for (let i = 1; i <= availableInstallments; i++) {
                const option = document.createElement('option');
                const installmentValue = total / i;
                
                if (i === 1) {
                    option.text = `À vista - ${formatCurrency(total)}`;
                } else {
                    option.text = `${i}x de ${formatCurrency(installmentValue)} (${formatCurrency(total)})`;
                }
                
                option.value = i;
                select.appendChild(option);
            }
        }
        
        async function validateCard() {
            if (selectedCard) return true;
            
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const cardName = document.getElementById('card-name').value.trim();
            const cardExpiry = document.getElementById('card-expiry').value;
            const cardCvv = document.getElementById('card-cvv').value;
            
            if (cardNumber.length < 16 || !/^\d+$/.test(cardNumber)) {
                alert('Número do cartão inválido');
                return false;
            }
            
            if (cardName.length < 3) {
                alert('Nome no cartão inválido');
                return false;
            }
            
            if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                alert('Data de validade inválida (use MM/AA)');
                return false;
            }
            
            if (cardCvv.length < 3 || !/^\d+$/.test(cardCvv)) {
                alert('CVV inválido');
                return false;
            }
            
            if (document.getElementById('save-card').checked) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/api/add-card', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            cardNumber: cardNumber,
                            cardHolderName: cardName,
                            cardExpiryDate: cardExpiry,
                            cardCVV: cardCvv
                        })
                    });
                    
                    if (!response.ok) throw new Error('Erro ao salvar cartão');
                    
                    const newCard = await response.json();
                    selectedCard = newCard;
                } catch (error) {
                    console.error('Erro ao salvar cartão:', error);
                    alert('Erro ao salvar cartão: ' + error.message);
                }
            }
            
            return true;
        }
        
        async function loadOrder(pedidoId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/pedidos/${pedidoId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar pedido');
                
                const pedido = await response.json();
                return pedido;
            } catch (error) {
                console.error('Erro ao carregar pedido:', error);
                throw error;
            }
        }
        
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user-profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar perfil');
                
                const user = await response.json();
                return user;
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                throw error;
            }
        }
        
        async function confirmPayment() {
            if (selectedPaymentMethod === 'card' && !await validateCard()) {
                return;
            }
            
            const btn = document.getElementById('confirm-payment-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            btn.disabled = true;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/confirm-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        orderId: currentOrder._id,
                        paymentMethod: selectedPaymentMethod,
                        cardId: selectedCard?._id,
                        installments: document.getElementById('installments').value
                    })
                });
                
                if (!response.ok) {
                    let errorMsg = 'Erro ao confirmar pagamento';
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || errorMsg;
                    } catch (e) {
                        errorMsg = response.statusText || errorMsg;
                    }
                    throw new Error(errorMsg);
                }
                
                const result = await response.json();
                currentOrder = result.order;
                
                // Atualiza a interface para mostrar confirmação
                document.getElementById('payment-section').style.display = 'none';
                document.getElementById('confirmation-section').style.display = 'block';
                
                document.getElementById('order-number').textContent = currentOrder._id;
                document.getElementById('order-date').textContent = formatDate(currentOrder.dataPedido);
                document.getElementById('payment-method').textContent = currentOrder.metodoPagamento;
                document.getElementById('order-total').textContent = formatCurrency(currentOrder.total);
                
                updateProgress(100);
                
            } catch (error) {
                console.error('Erro ao confirmar pagamento:', error);
                
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Erro de conexão com o servidor. Verifique sua internet.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'Serviço indisponível no momento. Tente novamente mais tarde.';
                }
                
                alert('Erro ao confirmar pagamento: ' + errorMessage);
            } finally {
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Pagamento';
                btn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Event listeners
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', () => {
                    const method = option.getAttribute('data-method');
                    selectPaymentMethod(option, method);
                });
            });

            document.getElementById('copy-boleto-btn').addEventListener('click', () => {
                const code = document.getElementById('boleto-code').textContent;
                navigator.clipboard.writeText(code.replace(/\s/g, ''));
                alert('Código copiado!');
            });

            document.getElementById('download-boleto-btn').addEventListener('click', generateBoletoPDF);
            document.getElementById('copy-pix-btn').addEventListener('click', () => {
                const key = document.getElementById('pix-key').textContent;
                navigator.clipboard.writeText(key);
                alert('Chave PIX copiada!');
            });

            document.getElementById('screenshot-btn').addEventListener('click', () => {
                alert('Agora você pode tirar um print da tela para salvar o QR Code do PIX');
            });

            document.getElementById('confirm-payment-btn').addEventListener('click', confirmPayment);
            document.getElementById('download-invoice-btn').addEventListener('click', generateInvoicePDF);

            document.getElementById('add-card-btn')?.addEventListener('click', () => {
                document.getElementById('card-number').value = '';
                document.getElementById('card-name').value = '';
                document.getElementById('card-expiry').value = '';
                document.getElementById('card-cvv').value = '';
                
                document.getElementById('card-number').disabled = false;
                document.getElementById('card-name').disabled = false;
                document.getElementById('card-expiry').disabled = false;
                document.getElementById('card-cvv').disabled = false;
                
                document.getElementById('card-number').focus();
            });

            document.getElementById('card-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '');
                if (value.length > 16) value = value.substring(0, 16);
                
                document.querySelectorAll('.card-image').forEach(img => {
                    img.classList.remove('active');
                });
                
                if (/^4/.test(value)) {
                    document.getElementById('visa').classList.add('active');
                } else if (/^5[1-5]/.test(value)) {
                    document.getElementById('mastercard').classList.add('active');
                } else if (/^3[47]/.test(value)) {
                    document.getElementById('amex').classList.add('active');
                } else if (/^6/.test(value)) {
                    document.getElementById('elo').classList.add('active');
                }
                
                value = value.replace(/(\d{4})/g, '$1 ').trim();
                e.target.value = value;
            });
            
            document.getElementById('card-expiry').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 4) value = value.substring(0, 4);
                
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                
                e.target.value = value;
            });
            
            document.getElementById('card-cvv').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = value;
            });

            // Carrega dados do pedido e usuário
            const urlParams = new URLSearchParams(window.location.search);
            const pedidoId = urlParams.get('pedidoId');
            
            if (!pedidoId) {
                alert('Pedido não encontrado');
                window.location.href = 'Mensalidade.html';
                return;
            }
            
            try {
                currentUser = await loadUserProfile();
                currentOrder = await loadOrder(pedidoId);
                
                // Atualiza resumo do pedido
                const resumoContainer = document.getElementById('order-summary');
                resumoContainer.innerHTML = '';
                
                currentOrder.servicos.forEach(servico => {
                    const item = document.createElement('div');
                    item.className = 'order-item';
                    item.innerHTML = `
                        <span>${servico.servico?.nome || 'Serviço'} (${servico.frequencia === 'anual' ? 'Anual' : 'Mensal'})</span>
                        <span>${formatCurrency(servico.valor)}</span>
                    `;
                    resumoContainer.appendChild(item);
                });
                
                document.getElementById('order-total-sidebar').textContent = formatCurrency(currentOrder.total);
                
                updateInstallments(currentOrder.total);
                
                // Seleciona método de pagamento padrão
                const defaultMethod = currentOrder.metodoPagamento || 'boleto';
                const defaultOption = document.querySelector(`.payment-option[data-method="${defaultMethod}"]`);
                if (defaultOption) {
                    selectPaymentMethod(defaultOption, defaultMethod);
                }
                
                updateProgress(66);
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados: ' + error.message);
                window.location.href = 'Mensalidade.html';
            }
        });
    </script>
</body>
</html>